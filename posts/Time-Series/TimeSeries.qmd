---
title: "Time Series Project"
author: "Karol Orozco"
date: "2022-10-04"
---

```{r, message=FALSE, warning=FALSE}

library(tidyverse)
library(lubridate); library(tsibble)
library(readxl)
library(fpp3)

library(showtext)
showtext_auto()

library(plotly)
library(feasts)
library(glue)


# Add fonts from Google.
font_add_google("Roboto Mono", "Roboto Mono")
font_add_google("Open Sans", "Open Sans")
font_add_google("Special Elite", "Special Elite")


```


## Step 1: Problem Definition

In this project, I will perform a time series analysis using Zillow's historical median home prices for the US from March 2015 to October 2022. The project aims to provide information on renting costs in Portland, OR, Colorado Springs, CO, and Orlando, FL, and find the month that offers the lowest price to move in.

## Step 2: Gathering Information

You can find this free dataset on the Zillow website: https://www.zillow.com/research/data/#other-metrics


```{r}
raw_city <- read.csv("C:/Users/karol/Desktop/Portfolio/City_zori_sm_month.csv")
```

- RegionID:	This is unique Id for the Regions
- SizeRank:	This is the ranking done based on the size of the region
- RegionName:	This field contains the name of the city.
- RegionType:	Type of region.
- StateName:	State
- State:	This column provide the specific City Name of Housing Data
- Metro:	This provide the name of the metro city around that region
- County: Name	This is the county name for that region
- Months: Column	These columns contains the prices of region for every month since 2015- 2022

## Step 3: Preliminary (exploratory) analysis.

```{r}

str(raw_city[,c(1:11)])
```

We have to make this dataset tidy. Tidy Data is a way of structuring data so that it can be easily understood by people and analyzed by machines.

I need to remove the X at the beginning of the dates (X3.31.2015,...)

```{r}
names(raw_city) <- sub("^X", "", names(raw_city))
str(raw_city[,c(1:10)],10)
```

Now, I will create a new column called Price, where the values from the dates column will merge into it.

```{r}
rent_city <- raw_city %>% 
  pivot_longer(-c(RegionID,SizeRank,RegionName,RegionType,StateName,State,Metro,CountyName),
    names_to = "Monthly",
    values_to = "Price"
  ) 
str(rent_city)

```

```{r}
#Converting the Date from factor to character

rent_clean <- rent_city %>%
            mutate(Monthly_parsed = as.Date(Monthly,"%m.%d.%Y"))


rent_clean[["Monthly"]]<- as.character(rent_clean$Monthly)

rent_city[["Monthly"]]<- as.character(rent_city$Monthly)
summary(rent_city)
```


We see some missing values in the Price variable, but before I deal with those values, I will filter my data to the cities that I am interested the most: Houston, Orlando, and Portland.


```{r}

preferred_cities <- rent_clean %>%
  dplyr:::filter(RegionName %in% c("Colorado Springs", "Orlando", "Portland")) %>%
  dplyr:::filter(RegionID %in% c("4172", "13121", "13373"))

summary(preferred_cities)
```


- After filtering the data, we don't have any missing values
- We see that the date goes from March 31, 2015, to September 30, 2022, with a monthly calculation of the rental value.
- The monthly rent cost goes from 1,172 to 2,153 dollars

#### Coerce to a tsibble with as_tsibble()- Three Cities

A time series can be recorded as a tsibble object in R. tsibble objects extend tidy data frames (tibble objects) by introducing temporal structure, and to do it, we need to declare key and index. In this case, the Monthly_parsed containing the data-time is the index and the RegionID is the key. Other columns can be considered as measured variables.

```{r fig.height= 10, message=FALSE, warning=FALSE}

tsb_pref_cities <- preferred_cities %>%
                   select(RegionName,RegionID, Monthly_parsed, Price)

tsb_pref_cities <-tsb_pref_cities%>%
  as_tsibble(key= RegionName, index= Monthly_parsed)%>%
                   index_by(year_month = ~ yearmonth(.))

tsibble_df <-tsb_pref_cities%>%
  select(-RegionID)%>%
  as_tsibble(key= RegionName, index= year_month)
```

To visualize the data, I could usee the autoplot() command, but I rather to create my graph with ggplot.

```{r, message=FALSE, warning=FALSE, fig.width= 9}

plot_cities <- tsibble_df %>%
  ggplot(aes(x= year_month, y= Price, color= RegionName)) +
  geom_line(size=1)+
   
    labs(y=" ", 
       x= "Year",
       title="Average Rent Price in Portland, Orlando & Houston, 2015-2022",
       caption = "data:https://www.zillow.com/research/data")+
  scale_y_continuous(labels=scales::dollar_format())+
  scale_colour_hue(name= " ")+
# Set ggplot theme
theme_set(theme_minimal(base_family = "Roboto Mono"))
theme_update(
  axis.text.y = element_text(size = 10),
    axis.text.x = element_text(size = 10),
  legend.title = element_text(size = 9),
  plot.caption = element_text(
    family = "Special Elite",
    size = 10,
    color = "grey70",
    face = "bold",
    margin = margin(5, 0, 20, 0)
  ),
  plot.margin = margin(10, 25, 10, 25)
)

plot_cities


```
#### Seasonal Plots

```{r, fig.width= 9, warning=FALSE, message=FALSE}
pdx <- tsibble_df %>%
  filter(RegionName == "Portland")

seas_pdx <- pdx%>%
gg_season(Price, labels = "both")+
  labs(x= "",
       y= "",
       title="Portland's Seasonal Plot")+
  
  scale_y_continuous(labels=scales::dollar_format())+
# Set ggplot theme
theme_set(theme_minimal(base_family = "Roboto Mono"))
theme_update(

  panel.grid.minor = element_blank(),
  axis.text.x = element_blank(),
  axis.text.y = element_text(size = 10),
  axis.ticks = element_blank(),
  axis.title.y = element_text(size = 13, margin = margin(r = 10)),
  legend.title = element_text(size = 9),
  plot.caption = element_text(
    family = "Special Elite",
    size = 10,
    color = "grey70",
    face = "bold",
    margin = margin(5, 0, 20, 0)
  ),
  plot.margin = margin(10, 25, 10, 25)
)
seas_pdx
```


```{r, fig.width= 9, warning=FALSE, message=FALSE}
colsp <- tsibble_df %>%
  filter(RegionName == "Colorado Springs")


seas_colsp <- colsp%>%
gg_season(Price, labels = "both")+
  labs(x= "",
       y= "",
       title="Colorado Springs' Seasonal Plot")+
  scale_y_continuous(labels=scales::dollar_format())+
# Set ggplot theme
theme_set(theme_minimal(base_family = "Roboto Mono"))
theme_update(
  panel.grid.minor = element_blank(),
  axis.text.x = element_blank(),
  axis.text.y = element_text(size = 10),
  axis.ticks = element_blank(),
  axis.title.y = element_text(size = 13, margin = margin(r = 10)),
  legend.title = element_text(size = 9),
  plot.caption = element_text(
    family = "Special Elite",
    size = 10,
    color = "grey70",
    face = "bold",
    margin = margin(5, 0, 20, 0)
  ),
  plot.margin = margin(10, 25, 10, 25)
)

seas_colsp
```


```{r, fig.width= 9, warning=FALSE, message=FALSE}
orl <- tsibble_df %>%
  filter(RegionName == "Orlando")


seas_orl <- orl%>%
gg_season(Price, labels = "both")+
  labs(x= "",
       y= "",
       title="Orlando's Seasonal Plot")+
  scale_y_continuous(labels=scales::dollar_format())+
# Set ggplot theme
theme_set(theme_minimal(base_family = "Roboto Mono"))
theme_update(
  panel.grid.minor = element_blank(),
  axis.text.x = element_blank(),
  axis.text.y = element_text(size = 10),
  axis.ticks = element_blank(),
  axis.title.y = element_text(size = 13, margin = margin(r = 10)),
  legend.title = element_text(size = 9),
  plot.caption = element_text(
    family = "Special Elite",
    size = 10,
    color = "grey70",
    face = "bold",
    hjust = .5,
    margin = margin(5, 0, 20, 0)
  ),
  plot.margin = margin(10, 25, 10, 25)
)

seas_orl
```

#### Subseries

```{r}

pdx%>%
gg_subseries(Price)+
  labs(y= "Rent Price",
       x= "Year")+theme_minimal()+
  scale_y_continuous(labels=scales::dollar_format())+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r}
colsp %>%
gg_subseries(Price)+
  labs(y= "Rent Price",
       x= "Year")+theme_minimal()+
  scale_y_continuous(labels=scales::dollar_format())+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
orl%>%
gg_subseries(Price)+
  labs(y= "Rent Price",
       x= "Year")+theme_minimal()+
  scale_y_continuous(labels=scales::dollar_format())+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
#### Features: Summary


```{r}

tsb_pref_cities %>%
    features(Price, features = list(mean = mean, min = min, max = max, sd = sd,
        quantile))
```

#### Decomposition Features

```{r}
feast_pref_cities <-
tsb_pref_cities %>% features(Price, feat_stl)

feast_pref_cities
```

#### coef_hurst

A measure of the degree to which adjacent observations depend on one another over time. Generically, this statistic takes values between zero and one with one indicating very high levels of dependence through time.

```{r}
tsb_pref_cities %>% features(Price,coef_hurst)
```
#### The Absence of Correlation

```{r}
tsb_pref_cities %>% features(Price, features = list(box_pierce, ljung_box))
```



## Step 4: Choosing and fitting models


## Step 5: Using and evaluating a forecasting model

